<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lead Dashboard - BritSync</title>
    <style>
        :root {
            --color-background: #ffffff;
            --color-surface: #f8f9fa;
            --color-text: #1a1a1a;
            --color-text-secondary: #6c757d;
            --color-primary: #0066cc;
            --color-primary-hover: #0052a3;
            --color-border: #e0e0e0;
            --color-card-border: #e8e8e8;
            --color-success: #28a745;
            --color-warning: #ffc107;
            --color-teal-500-rgb: 0, 102, 204;
            --color-brown-600-rgb: 224, 224, 224;
            --font-family-base: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            --radius-base: 8px;
            --radius-lg: 12px;
            --shadow-md: 0 2px 8px rgba(0, 0, 0, 0.08), 0 1px 3px rgba(0, 0, 0, 0.05);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: var(--font-family-base);
            background: var(--color-background);
            color: var(--color-text);
            padding: 24px;
            line-height: 1.6;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        header {
            margin-bottom: 32px;
        }

        h1 {
            font-size: 32px;
            font-weight: 600;
            margin-bottom: 8px;
            color: var(--color-text);
        }

        .subtitle {
            color: var(--color-text-secondary);
            font-size: 14px;
        }

        .status-bar {
            background: var(--color-surface);
            border: 1px solid var(--color-card-border);
            border-radius: var(--radius-base);
            padding: 12px 16px;
            margin-bottom: 24px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .status-indicator {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 14px;
        }

        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: var(--color-success);
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .status-dot.error {
            background: #dc3545;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 32px;
        }

        .stat-card {
            background: var(--color-surface);
            border: 1px solid var(--color-card-border);
            border-radius: var(--radius-lg);
            padding: 24px;
            box-shadow: var(--shadow-md);
        }

        .stat-label {
            font-size: 14px;
            color: var(--color-text-secondary);
            margin-bottom: 8px;
            font-weight: 500;
        }

        .stat-value {
            font-size: 36px;
            font-weight: 600;
            color: var(--color-text);
        }

        .stat-trend {
            font-size: 12px;
            color: var(--color-text-secondary);
            margin-top: 8px;
        }

        .actions {
            display: flex;
            gap: 12px;
            margin-bottom: 24px;
            flex-wrap: wrap;
        }

        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: var(--radius-base);
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
        }

        .btn-primary {
            background: var(--color-primary);
            color: white;
        }

        .btn-primary:hover {
            background: var(--color-primary-hover);
        }

        .btn-secondary {
            background: var(--color-surface);
            color: var(--color-text);
            border: 1px solid var(--color-border);
        }

        .btn-secondary:hover {
            background: var(--color-background);
        }

        .leads-table-container {
            background: var(--color-surface);
            border: 1px solid var(--color-card-border);
            border-radius: var(--radius-lg);
            overflow: hidden;
        }

        .table-header {
            padding: 20px;
            border-bottom: 1px solid var(--color-card-border);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .table-header h2 {
            font-size: 18px;
            font-weight: 600;
        }

        .filter-tabs {
            display: flex;
            gap: 8px;
        }

        .filter-tab {
            padding: 6px 16px;
            border: 1px solid var(--color-border);
            border-radius: var(--radius-base);
            background: transparent;
            color: var(--color-text);
            font-size: 13px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .filter-tab.active {
            background: var(--color-primary);
            color: white;
            border-color: var(--color-primary);
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        thead {
            background: var(--color-background);
        }

        th {
            text-align: left;
            padding: 14px 20px;
            font-size: 13px;
            font-weight: 600;
            color: var(--color-text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        td {
            padding: 16px 20px;
            border-top: 1px solid var(--color-card-border);
            font-size: 14px;
        }

        tbody tr:hover {
            background: var(--color-background);
        }

        .score-badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
        }

        .score-high {
            background: rgba(var(--color-teal-500-rgb), 0.15);
            color: var(--color-primary);
        }

        .score-low {
            background: rgba(var(--color-brown-600-rgb), 0.15);
            color: var(--color-text-secondary);
        }

        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: var(--color-text-secondary);
        }

        .empty-state svg {
            width: 64px;
            height: 64px;
            margin-bottom: 16px;
            opacity: 0.3;
        }

        .loading-spinner {
            display: inline-block;
            width: 16px;
            height: 16px;
            border: 2px solid var(--color-border);
            border-top-color: var(--color-primary);
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        @media (max-width: 768px) {
            .stats-grid {
                grid-template-columns: 1fr;
            }

            .table-header {
                flex-direction: column;
                align-items: flex-start;
                gap: 16px;
            }

            table {
                font-size: 12px;
            }

            th, td {
                padding: 12px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>Lead Generation Dashboard</h1>
            <p class="subtitle">Real-time lead tracking from BritSync workflow</p>
        </header>

        <div class="status-bar">
            <div class="status-indicator">
                <div class="status-dot" id="statusDot"></div>
                <span id="statusText">Connecting to workflow...</span>
            </div>
            <button class="btn btn-secondary" onclick="fetchLeads()" style="padding: 6px 12px; font-size: 13px;">
                <span id="refreshBtn">üîÑ Refresh Now</span>
            </button>
        </div>

        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-label">Total Leads</div>
                <div class="stat-value" id="totalLeads">0</div>
                <div class="stat-trend">All time</div>
            </div>

            <div class="stat-card">
                <div class="stat-label">Last 24 Hours</div>
                <div class="stat-value" id="leads24h">0</div>
                <div class="stat-trend" id="trend24h">No recent activity</div>
            </div>

            <div class="stat-card">
                <div class="stat-label">High Score (&gt;80)</div>
                <div class="stat-value" id="highScore">0</div>
                <div class="stat-trend" id="highScorePercent">0% of total</div>
            </div>

            <div class="stat-card">
                <div class="stat-label">Low Score (&lt;80)</div>
                <div class="stat-value" id="lowScore">0</div>
                <div class="stat-trend" id="lowScorePercent">0% of total</div>
            </div>
        </div>

        <div class="actions">
            <button class="btn btn-primary" onclick="exportToExcel()">
                <span>üìä Export to Excel</span>
            </button>
            <button class="btn btn-primary" onclick="exportToCSV()">
                <span>üìÑ Export to CSV</span>
            </button>
            <button class="btn btn-secondary" onclick="clearData()">
                <span>üóëÔ∏è Clear Data</span>
            </button>
        </div>

        <div class="leads-table-container">
            <div class="table-header">
                <h2>Lead Details</h2>
                <div class="filter-tabs">
                    <button class="filter-tab active" onclick="filterLeads('all')">All</button>
                    <button class="filter-tab" onclick="filterLeads('high')">High Score</button>
                    <button class="filter-tab" onclick="filterLeads('low')">Low Score</button>
                    <button class="filter-tab" onclick="filterLeads('24h')">Last 24h</button>
                </div>
            </div>
            <div id="tableContent">
                <div class="empty-state">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path>
                        <circle cx="12" cy="7" r="4"></circle>
                    </svg>
                    <h3>Loading leads...</h3>
                    <p>Fetching data from workflow</p>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ============= CONFIGURATION =============
        const WEBHOOK_URL = 'https://aur5.app.n8n.cloud/webhook-test/BritSyncLeads1';
        const STORAGE_KEY = 'britsync_leads';
        const FETCH_INTERVAL = 30000; // Fetch every 30 seconds
        // =========================================

        let currentFilter = 'all';
        let allLeads = [];
        let fetchTimer = null;

        // Initialize dashboard
        function init() {
            loadLeadsFromStorage();
            updateStats();
            renderTable();
            fetchLeads(); // Initial fetch
            startAutoFetch();
        }

        // Start automatic fetching
        function startAutoFetch() {
            if (fetchTimer) clearInterval(fetchTimer);
            fetchTimer = setInterval(fetchLeads, FETCH_INTERVAL);
        }

        // Fetch leads from webhook
        async function fetchLeads() {
            const statusDot = document.getElementById('statusDot');
            const statusText = document.getElementById('statusText');
            const refreshBtn = document.getElementById('refreshBtn');

            try {
                statusDot.className = 'status-dot';
                statusText.textContent = 'Fetching leads...';
                refreshBtn.innerHTML = '<span class="loading-spinner"></span> Fetching...';

                const response = await fetch(WEBHOOK_URL, {
                    method: 'GET',
                    headers: {
                        'Accept': 'application/json'
                    }
                });

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}`);
                }

                const data = await response.json();
                processWebhookData(data);

                statusDot.className = 'status-dot';
                statusText.textContent = `Connected ‚Ä¢ Last updated: ${new Date().toLocaleTimeString()}`;
                refreshBtn.innerHTML = 'üîÑ Refresh Now';

            } catch (error) {
                console.error('Fetch error:', error);
                statusDot.className = 'status-dot error';
                statusText.textContent = `Connection error: ${error.message}`;
                refreshBtn.innerHTML = 'üîÑ Retry';
            }
        }

        // Process incoming webhook data from Google Sheets
        function processWebhookData(data) {
            console.log('Received webhook data:', data);
            
            if (!data) {
                console.log('No data received');
                return;
            }

            // Handle different data structures
            let leads = [];
            
            if (Array.isArray(data)) {
                leads = data;
            } else if (data.leads && Array.isArray(data.leads)) {
                leads = data.leads;
            } else if (data.json && Array.isArray(data.json)) {
                leads = data.json;
            } else if (data.body && Array.isArray(data.body)) {
                leads = data.body;
            } else if (typeof data === 'object' && data.Name) {
                // Single lead object
                leads = [data];
            } else {
                console.log('Unknown data structure:', data);
                leads = [];
            }

            console.log('Parsed leads:', leads);

            if (leads.length === 0) {
                console.log('No leads to process');
                return;
            }

            let newLeadsCount = 0;

            leads.forEach(lead => {
                // Check if lead already exists (by row_number or email)
                const existingIndex = allLeads.findIndex(l => 
                    l.id === lead.row_number || 
                    (l.email === lead.Email && l.email !== 'N/A')
                );

                const processedLead = {
                    id: lead.row_number || Date.now() + Math.random(),
                    timestamp: lead.timestamp || new Date().toISOString(),
                    name: lead.Name || 'Unknown',
                    email: lead.Email || 'N/A',
                    phone: lead.Phone ? String(lead.Phone) : 'N/A',
                    company: lead.Company || 'N/A',
                    role: lead.Role || 'N/A',
                    location: lead.Location || 'N/A',
                    score: lead.Score || 0,
                    grade: lead.Score > 80 ? 'A' : lead.Score > 60 ? 'B' : lead.Score > 40 ? 'C' : 'D'
                };

                if (existingIndex >= 0) {
                    // Update existing lead
                    allLeads[existingIndex] = processedLead;
                } else {
                    // Add new lead
                    allLeads.push(processedLead);
                    newLeadsCount++;
                }
            });

            if (newLeadsCount > 0) {
                console.log(`Added ${newLeadsCount} new lead(s)`);
            }

            saveLeadsToStorage();
            updateStats();
            renderTable();
        }

        // Load leads from localStorage
        function loadLeadsFromStorage() {
            const stored = localStorage.getItem(STORAGE_KEY);
            if (stored) {
                try {
                    allLeads = JSON.parse(stored);
                } catch (e) {
                    console.error('Error loading leads:', e);
                    allLeads = [];
                }
            }
        }

        // Save leads to localStorage
        function saveLeadsToStorage() {
            localStorage.setItem(STORAGE_KEY, JSON.stringify(allLeads));
        }

        // Update statistics
        function updateStats() {
            const total = allLeads.length;
            const now = new Date();
            const oneDayAgo = new Date(now.getTime() - 24 * 60 * 60 * 1000);

            const leads24h = allLeads.filter(lead => new Date(lead.timestamp) > oneDayAgo).length;
            const highScore = allLeads.filter(lead => lead.score > 80).length;
            const lowScore = allLeads.filter(lead => lead.score <= 80).length;

            document.getElementById('totalLeads').textContent = total;
            document.getElementById('leads24h').textContent = leads24h;
            document.getElementById('highScore').textContent = highScore;
            document.getElementById('lowScore').textContent = lowScore;

            document.getElementById('trend24h').textContent = leads24h > 0 
                ? `${leads24h} new lead${leads24h !== 1 ? 's' : ''} collected`
                : 'No recent activity';

            document.getElementById('highScorePercent').textContent = total > 0 
                ? `${Math.round((highScore / total) * 100)}% of total`
                : '0% of total';

            document.getElementById('lowScorePercent').textContent = total > 0 
                ? `${Math.round((lowScore / total) * 100)}% of total`
                : '0% of total';
        }

        // Filter leads
        function filterLeads(filter) {
            currentFilter = filter;
            
            // Update active tab
            document.querySelectorAll('.filter-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            event.target.classList.add('active');

            renderTable();
        }

        // Render table
        function renderTable() {
            const tableContent = document.getElementById('tableContent');
            
            if (allLeads.length === 0) {
                tableContent.innerHTML = `
                    <div class="empty-state">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path>
                            <circle cx="12" cy="7" r="4"></circle>
                        </svg>
                        <h3>No leads yet</h3>
                        <p>Lead data will appear here when your workflow generates leads</p>
                    </div>
                `;
                return;
            }

            // Filter leads based on current filter
            let filteredLeads = [...allLeads];
            const now = new Date();
            const oneDayAgo = new Date(now.getTime() - 24 * 60 * 60 * 1000);

            switch (currentFilter) {
                case 'high':
                    filteredLeads = filteredLeads.filter(lead => lead.score > 80);
                    break;
                case 'low':
                    filteredLeads = filteredLeads.filter(lead => lead.score <= 80);
                    break;
                case '24h':
                    filteredLeads = filteredLeads.filter(lead => new Date(lead.timestamp) > oneDayAgo);
                    break;
            }

            if (filteredLeads.length === 0) {
                tableContent.innerHTML = `
                    <div class="empty-state">
                        <h3>No leads match this filter</h3>
                        <p>Try selecting a different filter</p>
                    </div>
                `;
                return;
            }

            // Sort by timestamp (newest first)
            filteredLeads.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));

            const tableHTML = `
                <table>
                    <thead>
                        <tr>
                            <th>Name</th>
                            <th>Company</th>
                            <th>Role</th>
                            <th>Email</th>
                            <th>Phone</th>
                            <th>Location</th>
                            <th>Score</th>
                            <th>Date</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${filteredLeads.map(lead => `
                            <tr>
                                <td>${lead.name}</td>
                                <td>${lead.company}</td>
                                <td>${lead.role}</td>
                                <td>${lead.email}</td>
                                <td>${lead.phone}</td>
                                <td>${lead.location}</td>
                                <td>
                                    <span class="score-badge ${lead.score > 80 ? 'score-high' : 'score-low'}">
                                        ${lead.score} (${lead.grade})
                                    </span>
                                </td>
                                <td>${new Date(lead.timestamp).toLocaleDateString()}</td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            `;

            tableContent.innerHTML = tableHTML;
        }

        // Export to CSV
        function exportToCSV() {
            if (allLeads.length === 0) {
                alert('No leads to export');
                return;
            }

            const headers = ['Name', 'Company', 'Role', 'Email', 'Phone', 'Location', 'Score', 'Grade', 'Date'];
            const rows = allLeads.map(lead => [
                lead.name,
                lead.company,
                lead.role,
                lead.email,
                lead.phone,
                lead.location,
                lead.score,
                lead.grade,
                new Date(lead.timestamp).toLocaleString()
            ]);

            let csv = headers.join(',') + '\n';
            rows.forEach(row => {
                csv += row.map(cell => `"${cell}"`).join(',') + '\n';
            });

            downloadFile(csv, 'leads-export.csv', 'text/csv');
        }

        // Export to Excel (HTML format readable by Excel)
        function exportToExcel() {
            if (allLeads.length === 0) {
                alert('No leads to export');
                return;
            }

            const headers = ['Name', 'Company', 'Role', 'Email', 'Phone', 'Location', 'Score', 'Grade', 'Date'];
            const rows = allLeads.map(lead => [
                lead.name,
                lead.company,
                lead.role,
                lead.email,
                lead.phone,
                lead.location,
                lead.score,
                lead.grade,
                new Date(lead.timestamp).toLocaleString()
            ]);

            let html = '<html><head><meta charset="utf-8"></head><body><table border="1">';
            html += '<tr>' + headers.map(h => `<th>${h}</th>`).join('') + '</tr>';
            rows.forEach(row => {
                html += '<tr>' + row.map(cell => `<td>${cell}</td>`).join('') + '</tr>';
            });
            html += '</table></body></html>';

            downloadFile(html, 'leads-export.xls', 'application/vnd.ms-excel');
        }

        // Download file helper
        function downloadFile(content, filename, mimeType) {
            const blob = new Blob([content], { type: mimeType });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            link.download = filename;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(url);
        }

        // Clear all data
        function clearData() {
            if (confirm('Are you sure you want to clear all lead data? This cannot be undone.')) {
                allLeads = [];
                saveLeadsToStorage();
                updateStats();
                renderTable();
            }
        }

        // Initialize on page load
        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>
